<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./styles/css/mypage.css" />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <title>Decheck</title>
  </head>
  <body>
    <header>
      <nav id="header_navigator">
        <div class="header_divider logo">
          <a href="landing.html">
            <img src="./images/decheck_logo.svg" alt="logo" />
          </a>
        </div>
        <div class="header_divider home_mypage">
          <span class="home_button header_middle">
            <a href="index.html"> 홈 </a>
          </span>
          <span class="mypage_button header_middle">
            <a href="mypage.html"> 마이페이지 </a>
          </span>
        </div>
        <div class="header_divider login_area">
          <a class="a_hover" href="">
            <button id="header_login_button">&nbsp</button>
          </a>
        </div>
        <div class="modal hidden">
          <div class="modal__background"></div>
          <div class="modal__content">
            <div class="modal_txt">정말 로그아웃 하시겠습니까?</div>
            <div class="button_container">
              <button id="modal_logout_button">확인</button>
              <button id="modal_close_button">취소</button>
            </div>
          </div>
        </div>
      </nav>
    </header>
    <div id="body_container">
      <div id="mypage_top_container">
        <div id="m_left_container" class="m_top_container">
          <div id="info_container">
            <span class="name_txt">&nbsp;</span>
            <div class="email_txt">&nbsp;</div>
            <div>오늘의 기록을 Decheck와 함께 남겨보세요</div>
          </div>
          <div id="m_left_button_container">
            <button id="info_edit" class="white_btn">정보 수정</button>
            <button id="delete_account" class="white_btn">회원 탈퇴</button>
            <div class="newmodal hidden">
              <div class="modal__background"></div>
              <div class="modal__content">
                <div class="modal_txt">정말 탈퇴 하시겠습니까?</div>
                <div class="button_container">
                  <button id="modal_delete_account_button">확인</button>
                  <button id="modal_delete_close_button">취소</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="m_right_container" class="m_top_container">
          <div id="m_today_record">
            <img src="./images/check.svg" />
            오늘의 총 기록 시간은&nbsp;<span>0분</span>&nbsp;입니다
          </div>
          <div id="m_right_button_container">
            <button id="today_sentence_edit" class="no_border_btn">
              오늘의 한마디
            </button>
            <button id="graph_btn" class="no_border_btn">
              이번 달 그래프 보기
            </button>
          </div>
        </div>
      </div>
      <div id="mypage_bottom_container">
        <div id="m_default_page">
          <div>
            마이페이지에서는<br />
            정보 수정 및 회원 탈퇴,<br />
            오늘의 한마디, 이번 달 그래프 보기가 가능합니다.<br />
            상단의 버튼들을 클릭해 이용해 보세요!
          </div>
          <div id="m_image_container">
            <img src="./images/mypage_left.svg" alt="mypage_default_img" />
            <img src="./images/mypage_right.svg" alt="mypage_default_img" />
          </div>
        </div>
        <div id="info_edit_page">
          <div class="m_title"><span> 회원 정보 수정 </span></div>
          <div id="info_buttons">
            <button id="nickname_edit_btn">닉네임 변경하기</button>
            <button id="password_edit_btn">비밀번호 변경하기</button>
          </div>
          <div id="nickname_edit_page">
            <div class="input_container">
              <label>닉네임</label>
              <input
                id="nickname_edit_input"
                type="text"
                maxlength="10"
                placeholder="2글자 이상, 10글자 이내로 작성해주세요"
              />
            </div>
            <div class="m_button_container">
              <button id="submit_nickname_edit" class="orange_button">
                변경
              </button>
              <button id="cancel_nickname_edit" class="white_button">
                취소
              </button>
            </div>
          </div>
          <div id="password_edit_page">
            <form class="input_container" id="password_container">
              <label>비밀번호</label>
              <input id="password_edit_input" type="password" />
              <div id="password_not_suit" class="warning_msg">
                8~16글자, 영문 대소문자, 숫자, 특수문자를 사용하세요.
              </div>
              <label>비밀번호 확인</label>
              <input id="password_confirm_input" type="password" />
              <div id="password_not_match" class="warning_msg">
                비밀번호가 일치하지 않습니다. 다시 확인해주세요.
              </div>
            </form>
            <div class="m_button_container">
              <button id="submit_password_edit" class="orange_button">
                변경
              </button>
              <button id="cancel_password_edit" class="white_button">
                취소
              </button>
            </div>
          </div>
          <div id="password_changed_page">
            <div>비밀번호 변경이 완료되었습니다.</div>
            <button>확인</button>
          </div>
        </div>
        <div id="today_sentence_page">
          <div class="m_title">
            <span> 오늘의 한마디 </span>
          </div>
          <img src="./images/today_sentence_img.svg" alt="today_sentence_img" />
          <div id="today_sentence_input_container">
            <div id="input_only_container">
              <input id="today_input" type="text" maxlength="35" />
              <img id="today_input_cancel" src="images/x.svg" />
            </div>
            <span>오늘의 한마디는 35글자까지 작성할 수 있습니다. </span>
          </div>
          <div class="m_button_container">
            <button id="submit_today_sentence" class="orange_button">
              변경
            </button>
            <button id="cancel_today_sentence" class="white_button">
              취소
            </button>
          </div>
        </div>
        <div id="graph_page">
          <div class="m_title">
            <span>
              <img src="./images/graph_icon.svg" alt="graph_img" />
              이번 달 그래프
            </span>
          </div>
          <div id="chart_container">
            <div id="chart"></div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="./firebase.js"></script>

    <script>
      const db = firebase.firestore();
      let userUid = "";
      let userSocial = "";
      const user = firebase.auth().currentUser;
      const headerLoginHref = document.querySelector(".a_hover");
      const headerLoginButton = document.querySelector("#header_login_button");
      let equalPassword = false;
      const openButton = document.querySelector("#header_login_button");
      const openDeleteAccountButton = document.querySelector("#delete_account");
      const modal = document.querySelector(".modal");
      const newmodal = document.querySelector(".newmodal");
      const closeButton = modal.querySelector("#modal_close_button");
      const modalBackground = modal.querySelector(".modal__background");
      const logoutButton = modal.querySelector("#modal_logout_button");
      const deleteButton = newmodal.querySelector(
        "#modal_delete_account_button"
      );
      const cancelButton = newmodal.querySelector("#modal_delete_close_button");
      const userName = document.querySelector(".name_txt");
      const userEmail = document.querySelector(".email_txt");

      let graphSet = false;
      // 유저 관리 함수 시작
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          // User is signed in, see docs for a list of available properties
          // https://firebase.google.com/docs/reference/js/firebase.User
          let uid = user.uid;
          userUid = user.uid;
          // 유저 정보 표시하기

          userEmail.textContent = user.email;

          let userDB = db.collection("users").doc(uid);

          // 닉네임 불러오기
          userDB.get().then((res) => {
            if (res.data()) {
              userName.textContent = `${res.data().nickname} 님`;
              userSocial = res.data().social;
            }
          });

          let todayMonth = new Date().getMonth() + 1;
          if (todayMonth < 10) {
            todayMonth = "0" + todayMonth;
          }
          let todayDay = new Date().getDate();
          if (todayDay < 10) {
            todayDay = "0" + todayDay;
          }
          const todayDate = `${new Date().getFullYear()} ${todayMonth} ${todayDay}`;

          // 시간 불러오기
          const userTime =
            document.querySelector("#m_today_record").children[1];

          userDB
            .collection("timeRecord")
            .doc(todayDate)
            .get()
            .then((res) => {
              if (res.data()) {
                let timeToMin = res.data().resultTime.length * 10;
                if (timeToMin < 60) {
                  userTime.textContent = `${timeToMin}분`;
                } else if (timeToMin >= 60 && timeToMin % 60 !== 0) {
                  userTime.textContent = `${(timeToMin / 60).toFixed(0)}시간 ${
                    timeToMin % 60
                  }분`;
                } else {
                  userTime.textContent = `${(timeToMin / 60).toFixed(0)}시간`;
                }
              }
            });

          // 페이지 불러오기
          const defaultPage = document.querySelector("#m_default_page");
          const infoEditPage = document.querySelector("#info_edit_page");
          const todaySentencePage = document.querySelector(
            "#today_sentence_page"
          );
          const passwordEditPage = document.querySelector(
            "#password_edit_page"
          );
          const nicknameEditPage = document.querySelector(
            "#nickname_edit_page"
          );
          const pwSucPage = document.querySelector("#password_changed_page");
          const graphPage = document.querySelector("#graph_page");
          // 버튼 불러오기
          const infoEditBtn = document.querySelector("#info_edit");
          const deleteAccBtn = document.querySelector("#delete_account");
          const todaySentenceBtn = document.querySelector(
            "#today_sentence_edit"
          );
          const graphBtn = document.querySelector("#graph_btn");
          const cancelBtn = document.querySelectorAll(".white_button");
          const todayCancelBtn = document.querySelector("#today_input_cancel");
          const todaySubmitBtn = document.querySelector(
            "#submit_today_sentence"
          );
          const nicknameEditBtn = document.querySelector("#nickname_edit_btn");
          const passwordEditBtn = document.querySelector("#password_edit_btn");
          const infoButtons = document.querySelector("#info_buttons");
          const submitNicknameEditBtn = document.querySelector(
            "#submit_nickname_edit"
          );
          const submitPasswordEditBtn = document.querySelector(
            "#submit_password_edit"
          );
          const pwSucBtn = pwSucPage.childNodes[3];

          // 인풋창 불러오기
          const todayTxt = document.querySelector("#today_input");
          const nicknameTxt = document.querySelector("#nickname_edit_input");
          const passwordTxt = document.querySelector("#password_edit_input");
          const passwordConfirmTxt = document.querySelector(
            "#password_confirm_input"
          );
          // 경고메세지 불러오기
          const warningMsg = document.querySelector("#password_not_match");
          const passwordNotSuit = document.querySelector("#password_not_suit");

          submitNicknameEditBtn.addEventListener("click", (e) => {
            e.preventDefault();

            if (nicknameTxt.value.length >= 2) {
              userDB
                .update({
                  nickname: nicknameTxt.value,
                })
                .then(() => {
                  console.log("Document successfully written! 업데이트");
                  window.location.reload();
                });
            }
          });

          // 비밀번호 유효성 검사 함수
          function Inspect(data, type) {
            switch (type) {
              case "nickname":
                const nickname = /^([a-zA-Z0-9가-힣]){2,10}$/;
                // 2~10글자, 영어, 한글, 숫자만 가능
                return nickname.test(data);
              case "email":
                const email =
                  /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*\.[a-zA-Z]{2,3}$/;
                return email.test(data);
              case "password":
                const password =
                  /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[$@$!%*?&])[A-Za-z\d$@$!%*?&]{8,16}/;
                //최소 8자 및 최대 16자, 대문자 하나 이상, 소문자 하나 이상, 숫자 하나 이상, 특수 문자 하나 이상
                return password.test(data);
              default:
                return false;
            }
          }

          // 비밀번호
          let usablePassword = false;
          const passwordContainer = document.querySelector(
            "#password_container"
          );

          passwordContainer.addEventListener("input", function (e) {
            e.preventDefault();
            if (passwordTxt.value.length > 3) {
              if (!Inspect(passwordTxt.value, "password")) {
                passwordNotSuit.style.visibility = "visible";
                usablePassword = false;
              } else if (Inspect(passwordTxt.value, "password")) {
                passwordNotSuit.style.visibility = "hidden";
                usablePassword = true;
              }
            }

            if (
              passwordTxt.value.length > 3 &&
              passwordConfirmTxt.value.length > 3 &&
              passwordTxt.value !== passwordConfirmTxt.value
            ) {
              warningMsg.style.visibility = "visible";
              equalPassword = false;
            } else if (
              passwordTxt.value.length > 3 &&
              passwordConfirmTxt.value.length > 3 &&
              passwordTxt.value === passwordConfirmTxt.value
            ) {
              warningMsg.style.visibility = "hidden";
              equalPassword = true;
            }

            if (!equalPassword && !usablePassword) {
              submitPasswordEditBtn.disabled = true;
            }
            if (equalPassword && usablePassword) {
              submitPasswordEditBtn.disabled = false;
            }
          });

          submitPasswordEditBtn.addEventListener("click", (e) => {
            e.preventDefault();

            const newPassword = passwordTxt.value;
            console.log(newPassword);
            user
              .updatePassword(newPassword)
              .then(() => {
                // Update successful.
                passwordTxt.value = "";
                passwordConfirmTxt.value = "";
                passwordEditPage.style.display = "none";
                pwSucPage.style.display = "flex";
              })
              .catch((error) => {
                // An error ocurred
                // ...
              });
          });

          nicknameEditBtn.addEventListener("click", (e) => {
            e.preventDefault();

            infoButtons.style.display = "none";
            nicknameEditPage.style.display = "flex";
          });

          passwordEditBtn.addEventListener("click", (e) => {
            e.preventDefault();
            if (!userSocial) {
              infoButtons.style.display = "none";
              passwordEditPage.style.display = "flex";
            }
          });

          pwSucBtn.addEventListener("click", (e) => {
            e.preventDefault();
            infoEditPage.style.display = "none";
            pwSucPage.style.display = "none";
            defaultPage.style.display = "flex";
            infoButtons.style.display = "flex";
          });

          // 버튼 마다 이벤트 동작
          infoEditBtn.addEventListener("click", (e) => {
            e.preventDefault();
            if (userSocial || user.email === "guest@decheck.com") {
              passwordEditBtn.style.display = "none";
            }
            defaultPage.style.display = "none";
            infoEditPage.style.display = "flex";
            todaySentencePage.style.display = "none";
            graphPage.style.display = "none";
          });

          todaySentenceBtn.addEventListener("click", (e) => {
            e.preventDefault();
            defaultPage.style.display = "none";
            graphPage.style.display = "none";
            infoEditPage.style.display = "none";
            todaySentencePage.style.display = "flex";
          });

          cancelBtn.forEach((el) => {
            el.addEventListener("click", (e) => {
              e.preventDefault();
              defaultPage.style.display = "flex";
              graphPage.style.display = "none";
              infoEditPage.style.display = "none";
              todaySentencePage.style.display = "none";
              infoButtons.style.display = "flex";
              nicknameEditPage.style.display = "none";
              passwordEditPage.style.display = "none";
              nicknameTxt.value = "";
              passwordTxt.value = "";
              passwordConfirmTxt.value = "";
              todayTxt.value = "";
            });
          });

          // 회원 탈퇴
          deleteButton.addEventListener("click", (e) => {
            e.preventDefault();
            db.collection("users")
              .doc(uid)
              .delete()
              .then(() => {
                user
                  .delete()
                  .then(() => {
                    // User deleted.
                    window.location.replace("/landing.html");
                  })
                  .catch((error) => {
                    // An error ocurred
                    // ...
                  });
              })
              .catch((error) => {
                console.error("Error removing document: ", error);
              });
          });

          // 오늘의 한마디
          todaySubmitBtn.addEventListener("click", (e) => {
            e.preventDefault();
            userDB
              .collection("today")
              .doc("today")
              .set({
                title: todayTxt.value,
              })
              .then((res) => {
                todayTxt.value = "";
                defaultPage.style.display = "flex";
                infoEditPage.style.display = "none";
                todaySentencePage.style.display = "none";
              });
          });

          todayCancelBtn.addEventListener("click", (e) => {
            e.preventDefault();
            todayTxt.value = "";
          });

          // 이번달 그래프

          graphBtn.addEventListener("click", (e) => {
            e.preventDefault();
            infoEditPage.style.display = "none";
            defaultPage.style.display = "none";
            todaySentencePage.style.display = "none";
            graphPage.style.display = "flex";
            let arrDates = [];
            let arrTimes = [];
            let test = db
              .collection("users")
              .doc(uid)
              .collection("timeRecord")
              .onSnapshot((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                  if (new Date().getMonth() + 1 === +doc.id.split(" ")[1]) {
                    arrDates.push(doc.id.split(" ")[2]);
                    arrTimes.push(doc.data().resultTime.length * 10);
                  }
                });
              });

            var options = {
              chart: {
                id: "area-datetime",
                type: "area",
                height: 350,
                zoom: {
                  autoScaleYaxis: true,
                },
              },
              tooltip: {
                x: {
                  format: "dd MMM yyyy",
                },
              },
              series: [
                {
                  data: arrTimes,
                },
              ],
              xaxis: {
                categories: arrDates,
              },
            };

            var chart = new ApexCharts(
              document.querySelector("#chart"),
              options
            );

            setTimeout(() => {
              if (!graphSet) {
                chart.render();
                graphSet = true;
              }
            }, 500);
          });

          headerLoginButton.textContent = "로그아웃";
          headerLoginHref.href = "";
          console.log(user, "로그인했당");

          function displayModal(e) {
            e.preventDefault();
            modal.classList.toggle("hidden");
          }

          function newdisplayModal(e) {
            e.preventDefault();
            newmodal.classList.toggle("hidden");
          }

          cancelButton.addEventListener("click", newdisplayModal);
          if (user.email !== "guest@decheck.com") {
            openDeleteAccountButton.addEventListener("click", newdisplayModal);
          }
          openButton.addEventListener("click", displayModal);
          closeButton.addEventListener("click", displayModal);

          logoutButton.addEventListener("click", (e) => {
            e.preventDefault();
            firebase
              .auth()
              .signOut()
              .then(function () {
                console.log("로그아웃 성공");
                headerLoginHref.href = "login.html";
                headerLoginButton.textContent = "로그인";
                modal.classList.add("hidden");
                window.location.reload();
              })
              .catch(function (error) {
                console.log(error);
              });
          });
        } else {
          headerLoginHref.href = "login.html";
          headerLoginButton.textContent = "로그인";
          // User is signed out
          // ...
          userName.textContent = `마이페이지는`;
          userEmail.textContent = `체험하기 및 로그인 하시면 이용 가능한 서비스입니다.`;
        }
      });
      // 유저 관리 함수 끝
    </script>
    <footer>
      <a
        id="a_github"
        href="https://github.com/suzyhwang/Decheck/wiki"
        target="_blank"
      >
        <div id="github_container">
          <img src="./images/github_icon.svg" alt="github_icon" />
          <span id="github_name">suzyhwang</span>
        </div>
      </a>
      <address>
        <a href="mailto:soyeongsuzyhwang@gmail.com" id="inquiry_txt">
          문의하기
        </a>
      </address>
    </footer>
  </body>
</html>
