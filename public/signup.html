<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles/css/signup.css" />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <title>Decheck</title>
  </head>
  <body>
    <header>
      <nav id="header_navigator">
        <div class="header_divider logo">
          <a href="landing.html">
            <img src="./images/decheck_logo.svg" alt="logo" />
          </a>
        </div>
        <div class="header_divider home_mypage">
          <span class="home_button header_middle">
            <a href="index.html"> 홈 </a>
          </span>
          <span class="mypage_button header_middle">
            <a href="mypage.html"> 마이페이지 </a>
          </span>
        </div>
        <div class="header_divider login_area">
          <a class="a_hover" href="login.html">
            <button id="header_login_button">로그인</button>
          </a>
        </div>
      </nav>
    </header>

    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script src="./firebase.js"></script>

    <div id="container">
      <div class="login_container">
        <form id="registerForm">
          <div class="login_title">
            <span> 회원가입 </span>
          </div>
          <label for="userNickname">닉네임</label>
          <input
            type="text"
            maxlength="10"
            name="userNickname"
            placeholder="10글자 이내로 작성해주세요"
            required
          />
          <label for="userEmail">이메일</label>
          <div class="email_container">
            <input id="user_email" type="email" name="userEmail" required />
            <button id="email_check_btn" class="button">중복 확인</button>
          </div>
          <div id="email_format">이메일을 형식에 맞게 작성해주세요.</div>
          <div id="email_check">이메일 중복 확인이 필요합니다.</div>
          <div id="email_fail">이미 가입된 이메일입니다.</div>
          <div id="email_pass">사용 가능한 이메일입니다.</div>
          <label for="userPassword">비밀번호</label>
          <input type="password" name="userPassword" required />
          <div id="password_not_suit" class="warning_msg">
            8~16글자, 영문 대소문자, 숫자, 특수문자를 사용하세요.
          </div>
          <label for="userPasswordCheck">비밀번호 확인</label>
          <input type="password" name="userPasswordCheck" required />
          <div id="password_not_match" class="warning_msg">
            비밀번호가 일치하지 않습니다. 다시 확인해주세요.
          </div>
          <button
            id="login_button"
            class="button"
            type="submit"
            disabled="true"
          >
            확인
          </button>
        </form>

        <a href="login.html">
          <span id="go_signup">이미 회원이신가요? 로그인 하러가기</span>
        </a>
      </div>
    </div>

    <footer>
      <a href="https://github.com/suzyhwang/Decheck/wiki" target="_blank">
        <div id="github_container">
          <img src="./images/github_icon.svg" alt="github_icon" />
          <span id="github_name">suzyhwang</span>
        </div>
      </a>
      <span id="inquiry_txt">문의하기</span>
    </footer>
    <script>
      const emailCheckReqMsg = document.querySelector("#email_check");
      const emailCheck = document.querySelector("#email_check_btn");
      const emailUsable = document.querySelector("#email_pass");
      const emailNotUsable = document.querySelector("#email_fail");
      const emailInvalid = document.querySelector("#email_format");
      const warningMsg = document.querySelector("#password_not_match");
      const registerForm = document.querySelector("#registerForm");
      const passwordNotSuit = document.querySelector("#password_not_suit");
      let db = firebase.firestore();
      let equalPassword = false;
      let validEmail = false;
      let validNickname = false;
      const loginButton = document.querySelector("#login_button");
      const userEmail = document.querySelector("#user_email");

      // const db = firebase.firestore();
      // db.collection("todolist")
      //   .get()
      //   .then((res) => {
      //     res.forEach((doc) => {
      //       const todo = document.querySelector(".test");
      //       let todoDiv = document.createElement("span");
      //       let todoInput = document.createElement("input");
      //       todoInput.type = "checkbox";
      //       todoInput.checked = doc.data().boolean;
      //       todo.append(todoInput);
      //       todo.append(todoDiv);
      //       todoDiv.textContent = `${doc.data().title}`;
      //     });
      //   });

      registerForm.addEventListener("input", function (e) {
        e.preventDefault();
        const email = registerForm["userEmail"].value;
        const password = registerForm["userPassword"].value;
        const passwordCheck = registerForm["userPasswordCheck"].value;
        const nickname = registerForm["userNickname"].value;

        if (nickname.length >= 1) {
          validNickname = true;
        } else if (nickname.length === 0) {
          validNickname = false;
        }

        function Inspect(data, type) {
          switch (type) {
            case "nickname":
              const nickname = /^([a-zA-Z0-9가-힣]){2,10}$/;
              // 2~10글자, 영어, 한글, 숫자만 가능
              return nickname.test(data);
            case "email":
              const email =
                /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*\.[a-zA-Z]{2,3}$/;
              return email.test(data);
            case "password":
              const password =
                /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[$@$!%*?&])[A-Za-z\d$@$!%*?&]{8,16}/;
              //최소 8자 및 최대 16자, 대문자 하나 이상, 소문자 하나 이상, 숫자 하나 이상, 특수 문자 하나 이상
              return password.test(data);
            default:
              return false;
          }
        }
        emailCheck.addEventListener(
          "click",
          function (e) {
            e.preventDefault();
            firebase
              .auth()
              .signInWithEmailAndPassword(email, "1")
              .catch((err) => {
                if (err.code === "auth/wrong-password") {
                  emailCheckReqMsg.style.display = "none";
                  emailUsable.style.display = "none";
                  emailNotUsable.style.display = "block";
                  emailInvalid.style.display = "none";
                  validEmail = false;
                  console.log("등록된 이메일입니다.");
                } else if (err.code === "auth/user-not-found") {
                  emailCheckReqMsg.style.display = "none";
                  emailUsable.style.display = "block";
                  emailNotUsable.style.display = "none";
                  emailInvalid.style.display = "none";
                  validEmail = true;
                  console.log("사용가능한 이메일입니다.");
                } else if (err.code === "auth/invalid-email") {
                  emailCheckReqMsg.style.display = "none";
                  emailUsable.style.display = "none";
                  emailNotUsable.style.display = "none";
                  emailInvalid.style.display = "block";
                  validEmail = false;
                } else {
                  console.log("auth/too-many-requests");
                  emailCheckReqMsg.style.display = "block";
                  emailUsable.style.display = "none";
                  emailNotUsable.style.display = "none";
                  emailInvalid.style.display = "none";
                  validEmail = false;
                }
              });
          },
          { once: true }
        );

        if (password.length > 3) {
          if (!Inspect(password, "password")) {
            passwordNotSuit.style.visibility = "visible";
          } else if (Inspect(password, "password")) {
            passwordNotSuit.style.visibility = "hidden";
          }
        }

        if (
          password.length > 3 &&
          passwordCheck.length > 3 &&
          password !== passwordCheck
        ) {
          warningMsg.style.visibility = "visible";
          equalPassword = false;
        } else if (
          password.length > 3 &&
          passwordCheck.length > 3 &&
          password === passwordCheck
        ) {
          warningMsg.style.visibility = "hidden";
          equalPassword = true;
        }

        if (validEmail && validNickname && equalPassword) {
          loginButton.disabled = false;
          loginButton.style.background = "#DB643E";
        } else {
          loginButton.disabled = true;
          loginButton.style.background = "rgba(219, 100, 62, 0.37);";
        }

        registerForm.addEventListener("submit", function (e) {
          e.preventDefault();
          firebase
            .auth()
            .createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
              // Signed in

              let user = userCredential.user;
              let uid = user.uid;

              db.collection("users")
                .doc(uid)
                .set({
                  nickname,
                  uid,
                  social: false,
                })
                .then(() => {
                  db.collection("users")
                    .doc(uid)
                    .collection("today")
                    .doc("today")
                    .set({
                      color: "#edb4a3",
                    })
                    .then(() => {
                      console.log("Document successfully written!");
                      window.location.replace("/index.html");
                    })
                    .catch((error) => {
                      console.error("Error writing document: ", error);
                    });
                })
                .catch((error) => {
                  console.error("Error writing document: ", error);
                });

              // ...
            })
            .catch((error) => {
              let errorCode = error.code;
              let errorMessage = error.message;
              // ..
            });
        });
      });

      // const emailKeyup = userEmail.addEventListener("keyup", () => {
      // });
      const Register = registerForm.addEventListener("submit", (e) => {});
    </script>
  </body>
</html>
